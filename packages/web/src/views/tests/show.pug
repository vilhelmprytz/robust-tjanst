extends ../layout

mixin toggles
  button(class="toggler flex flex-grow items-center text-left pl-4 self-stretch"  data-toggle)
    span(class="icon inline-block") ⌃

mixin test(test)
  div(class=`test loading`)
    div(class=`flex items-center flex-row hover:bg-indigo-100 px-4 border-b-2 border-yellow`)
      div(class="py-5 flex items-center")
        if test.passed
          span(class="test__result text-green text-4xl") •
        else
          span(class="test__result text-red text-4xl") •
        h2(class=`text-xl ml-2`)= test.title
      +toggles
      img(src="/img/loading.svg" class="spinner")

    div(class="test__description mx-4")
      | !{md.render(test.description)}

mixin result_summary
  div(class="test__summary mr-4 mb-2 mt-4")
    block

block content
  div(class="flex flex-col")
    h1(class="mt-8 text-4xl")
      | Resultat för #{domain.domain_name}

  div(class="results flex flex-col mb-12")
    each group in groups
      section(class="test-group mb-8 mt-8")
        div(class="flex flex-row items-center")
          if group.result.success 
            img(src="/img/robust_symbol_green.svg" class="mr-4")
          else
            img(src="/img/robust_symbol_red.svg" class="mr-4")
          h1(class="text-3xl")= group.title 
        p(class="mt-1")= group.description

        +result_summary
          p 
            | <b>Resultat: </b>
            = group.result.description


        each test in group.tests
          +test(test)
        
block script
  script(type="application/javascript").
    const tests = document.querySelectorAll('.test-group > .test')
    for (const test of tests) {
      const togglers = test.querySelectorAll('[data-toggle]')
      for (const t of togglers) {
        t.addEventListener('click', function() {
          if (!test.classList.contains('loading'))
            test.classList.toggle('open')
        })
      }
    }

    const groups = document.querySelectorAll('.test-group')
    for (const group of groups) {
      const queue = Array.from(group.querySelectorAll('.test.loading'))
      console.log(queue)

      const MAX_TIME = 1000
      const MIN_TIME = 500

      function pop() {
        if (queue.length === 0) return
        const test = queue.shift()
        setTimeout(
          () => {
            test.classList.remove('loading')
            test.querySelector('img.spinner').remove()
            pop()
          },
          Math.random() * (MAX_TIME - MIN_TIME) + MIN_TIME
        )
      }
      pop()
    }